<dom-module id="current-charges">
  <template>
    <style include="shared-styles">

      :host {
        --paper-item-body-two-line-min-height: 60px;
      };

      iron-list { max-height: 28vh; }

      .selected {
        background-color: #a9eaff;
      }

      .red { color: #900; }
      .green { color: #4BB543; }

      .totals {
        font-size: 60%;
        color: #666;
        margin-top: -2rem;
        margin-bottom: 1rem;
      }

      .totals div {
        margin-right: 1rem;
      }

      paper-icon-item {
        min-height: 0;
      }

    </style>

    <iron-ajax
      id="ajax"
      auto
      url="/charges/[[asBase64(currentDate)]]"
      handle-as="json"
      on-response="animate"
      last-response="{{charges}}">
    </iron-ajax>

    <div class="horizontal layout center-center totals">
      <div class="vertical layout center">
        <span>Sunday</span>
        <strong class$="[[colorCodeHours(currentDate, 0, charges)]]">
          [[chargesFor(currentDate, 0, charges)]]
        </strong>
      </div>
      <div class="vertical layout center">
        <span>Monday</span>
        <strong class$="[[colorCodeHours(currentDate, 1, charges)]]">
          [[chargesFor(currentDate, 1, charges)]]
        </strong>
      </div>
      <div class="vertical layout center">
        <span>Tuesday</span>
        <strong class$="[[colorCodeHours(currentDate, 2, charges)]]">
          [[chargesFor(currentDate, 2, charges)]]
        </strong>
      </div>
      <div class="vertical layout center">
        <span>Wednesday</span>
        <strong class$="[[colorCodeHours(currentDate, 3, charges)]]">
          [[chargesFor(currentDate, 3, charges)]]
        </strong>
      </div>
      <div class="vertical layout center">
        <span>Thursday</span>
        <strong class$="[[colorCodeHours(currentDate, 4, charges)]]">
          [[chargesFor(currentDate, 4, charges)]]
        </strong>
      </div>
      <div class="vertical layout center">
        <span>Friday</span>
        <strong class$="[[colorCodeHours(currentDate, 5, charges)]]">
          [[chargesFor(currentDate, 5, charges)]]
        </strong>
      </div>
      <div class="vertical layout center">
        <span>Saturday</span>
        <strong class$="[[colorCodeHours(currentDate, 6, charges)]]">
          [[chargesFor(currentDate, 6, charges)]]
        </strong>
      </div>
      <div class="vertical layout center">
        <span>Week Total</span>
        <strong>[[totalHours(charges)]]</strong>
      </div>
    </div>

    <iron-list
      id="chargesList"
      items="[[sortedCharges(charges.*)]]"
      selected-items="{{selectedCharges}}"
      selection-enabled
      multi-selection>
      <template>
        <paper-icon-item class$="[[_computeSelected(selected)]]">
          <charge-item-display charge="[[item]]" item-icon>
          </charge-item-display>
          <paper-item-body two-line>
            <div class="horizontal layout">
              <span class="flex">[[getItemTitle(item)]]</span>
              <strong>[[item.Hours]]</strong>
            </div>
            <div secondary>
              <small>[[item.WorkComment]]</small>
            </div>
          </paper-item-body>
        </paper-icon-item>
      </template>
    </iron-list>

  </template>
  <script>
    (() => {
      'use strict';

      class CurrentCharges {
        get is() { return 'current-charges' }

        get behaviors() {
          return [
            Polymer.NeonAnimationRunnerBehavior
          ];
        }

        get properties() {
          return {
            selectedCharges: {
              type: Array,
              notify: true
            },
            animationConfig: {
              value: function () {
                return {
                  'cool': [{
                    name: 'cascaded-animation',
                    animation: 'fade-in-animation'
                  }]
                };
              }
            }

          };
        }

        animate() {
          this.async(() => {
            let items = Polymer.dom(this.root).querySelectorAll('paper-icon-item');
            this.animationConfig['cool'][0].nodes = items;
            this.playAnimation('cool');
          });
        }

        regenerate() {
          let date = this.asBase64(this.currentDate);
          this.$.ajax.url = `/charges/${date}`;
          this.$.ajax.generateRequest();
        }

        getItemTitle(item) {
          return item.ActivityCode ? item.ActivityCode : item.TaskName;
        }

        asBase64(date) {
          let start = moment(date).day(0).hour(0).minute(0).unix();
          let end = moment(date).day(6).hour(23).minute(59).unix();
          return btoa(start + '|' + end);
        }

        colorCodeHours(date, dayOfWeek, charges) {
          return this.chargesFor(date, dayOfWeek, charges) < 8 ? 'red' : 'green';
        }

        chargesFor(date, dayOfWeek, charges) {
          return charges
            .filter(c => moment(c.TimeEntryDate).day() == dayOfWeek)
            .map(c => parseFloat(c.Hours))
            .reduce((a,b) => a + b, 0)
            .toFixed(2);
        }

        totalHours(charges) {
          return charges
            .map(c => parseFloat(c.Hours))
            .reduce((a,b) => a + b, 0)
            .toFixed(2);
        }

        sortedCharges(chargesPath) {
          return chargesPath.base
            .sort((a, b) => moment(a.TimeEntryDate) - moment(b.TimeEntryDate));

        }

        _computeSelected(selected) {
          return selected ? 'selected' : '';
        }
      }

      Polymer(CurrentCharges);

    })();
  </script>
</dom-module>