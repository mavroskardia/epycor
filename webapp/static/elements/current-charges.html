<dom-module id="current-charges">
  <template>
    <style include="shared-styles">

      iron-list {
        height: 34vh;
      }

      .approved { color: #0f0; }
      .entered { color: #00f; }
      .new { color: #f00; }

      .selected { font-weight: bold; }

    </style>

    <iron-ajax
      id="ajax"
      auto
      url="/charges/[[asBase64(currentDate)]]"
      handle-as="json"
      last-response="{{charges}}">
    </iron-ajax>

    <iron-list
      id="chargesList"
      items="[[charges]]"
      selected-items="{{selectedCharges}}"
      selection-enabled
      multi-selection>
      <template>
        <paper-icon-item class$="[[_computeSelected(selected)]]">
          <div class="horizontal layout" item-icon>
            <iron-icon
              icon="[[getIcon(item)]]"
              item-icon
              class$="[[getIconClass(item)]]">
            </iron-icon>
          </div>
          <paper-item-body two-line>
            <div class="horizontal layout">
              <span class="flex">[[item.ActivityCode]]</span>
              <span>[[item.Hours]]</span>
            </div>
            <div secondary>
              <small>[[item.WorkComment]]</small>
            </div>
          </paper-item-body>
        </paper-icon-item>
      </template>
    </iron-list>

  </template>
  <script>
    (() => {
      'use strict';

      class CurrentCharges {
        get is() { return 'current-charges' }

        get properties() {
          return {
            selectedCharges: {
              type: Array,
              notify: true
            }
          };
        }

        regenerate() {
          let date = this.asBase64(this.currentDate);
          this.$.ajax.url = `/charges/${date}`;
          this.$.ajax.generateRequest();
        }

        getIcon(item) {
          let icons = {
            'A': 'done',
            'E': 'flag',
            'N': 'av:fiber-new'
          };

          return item.StatusCode in icons ? icons[item.StatusCode] : 'bug-report';
        }

        getIconClass(item) {
          let classes = {
            'A': 'approved',
            'E': 'entered',
            'N': 'new'
          };

          return item.StatusCode in classes ? classes[item.StatusCode] : '';
        }

        asBase64(date) {
          let start = moment(date).day(0).hour(0).minute(0).unix();
          let end = moment(date).day(6).hour(23).minute(59).unix();
          return btoa(start + '|' + end);
        }

        _computeSelected(selected) {
          return selected ? 'selected' : '';
        }
      }

      Polymer(CurrentCharges);

    })();
  </script>
</dom-module>