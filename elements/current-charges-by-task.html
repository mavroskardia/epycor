<link rel="import" href="../bower_components/polymer/polymer-element.html">

<link rel="import" href="../bower_components/iron-collapse/iron-collapse.html">
<link rel="import" href="../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../bower_components/iron-icon/iron-icon.html">

<link rel="import" href="shared-styles.html">
<link rel="import" href="chargebase.html">
<link rel="import" href="charge-item.html">

<dom-module id="current-charges-by-task">
  <template>

    <style include="shared-styles">

      header {
        display: block;
        width: 100%;
        cursor: pointer;
      }

      header span {
        margin-right: 2rem;
      }

      header strong {
        display: inline-block;
        width: 8rem;
        white-space: nowrap;
        text-overflow: ellipsis;
        overflow: hidden;
      }

    </style>

    <template is="dom-repeat" items="[[groupCharges(charges)]]">
      <div>
        <header class="horizontal layout center" on-tap="expand">
          <iron-icon icon="expand-more"></iron-icon>
          <strong class="flex">[[item.key]]</strong>
          <span>[[numCharges(item.values)]]</span>
          <strong>
            <iron-icon icon="schedule"></iron-icon>
            [[totalHours(item.values)]]h
          </strong>
        </header>
        <iron-collapse>
          <paper-listbox>
            <template is="dom-repeat" items="[[item.values]]" as="charge">
              <charge-item charge="[[charge]]"></charge-item>
            </template>
          </paper-listbox>
        </iron-collapse>
      </div>
    </template>

  </template>
  <script>
    (() => {
      'use strict';

      class CurrentChargesByTask extends EpycorChargeBase(EpycorUtilities(Polymer.Element)) {

        static get is() { return 'current-charges-by-task' }

        groupCharges(charges) {
          return this.groupByAsArray(
            charges.map(c => {
              c.title = this.getTitle(c);
              return c;
            }), 'title');
        }

        expand(evt, detail) {
          let node = evt.target;
          while (node.tagName !== "HEADER") node = node.parentElement;
          node.nextElementSibling.toggle();
        }

      }

      customElements.define(CurrentChargesByTask.is, CurrentChargesByTask);

    })();
  </script>
</dom-module>