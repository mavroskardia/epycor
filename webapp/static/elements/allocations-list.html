<dom-module id="allocations-list">
  <template>
    <style include="shared-styles">

      #msg {
        margin-top: 3rem;
      }

      .filterheader {
        background-color: #fff;
        padding: 1rem;
        height: 6rem;
      }

      em {
        color: var(--secondary-text-color);
      }

      strong {
        display: block;
      }

      paper-spinner, h2 {
        display: inline-block;
        margin-right: 1rem;
      }

      iron-list {
        height: 79vh;
      }

      paper-input {
        width: calc(100% - 2rem);
      }

    </style>

    <iron-ajax id="ajax"
      url="/allocations/[[dateRangeInBase64]]"
      method="get"
      handle-as="json"
      loading="{{loading}}"
      last-response="{{allocations}}">
    </iron-ajax>

    <div id="msg" hidden="{{!loading}}" class="horizontal layout center center-center">
      <paper-spinner active></paper-spinner>
      <em>Retrieving your allocations...</em>
    </div>

    <div hidden="{{loading}}">

      <paper-material elevation="2" class="filterheader">
        <div class="horizontal layout">
          <span class="flex">
            Showing [[filteredCount]] out of [[allocationCount]] Allocations
          </span>
          <!-- <div class="horizontal layout">
            <span>Tree View</span>
            <paper-toggle-button></paper-toggle-button>
          </div> -->
        </div>
        <paper-input id="filterinput" autofocus value="{{filter}}" label="Filter allocations">
          <div suffix>
            <paper-icon-button icon="clear" on-tap="clearFilter">
            </paper-icon-button>
          </div>
        </paper-input>
      </paper-material>

      <iron-list id="codelist"
        items="[[filteredAllocations]]"
        selection-enabled
        selected-item="{{selectedCode}}">
        <template>
          <paper-item>
            <paper-item-body two-line="[[item.breadcrumb]]">
              <strong>[[item.caption]]</strong>
              <breadcrumb-display
                hidden$="[[!item.breadcrumb]]"
                secondary
                item="[[item]]">
              </breadcrumb-display>
            </paper-item-body>
          </paper-item>
        </template>
      </iron-list>

    </div>

  </template>
  <script>
    (() => {
      'use strict';

      class AllocationsList {

        get is() { return 'allocations-list' }

        get properties() {
          return {
            selectedCode: {
              type: Object,
              notify: true
            },
            filteredAllocations: {
              type: Array,
              notify: true,
              computed: 'filterAllocations(filter, allocations)'
            },
            allocationCount: {
              type: Number,
              computed: 'countAllocations(allocations)'
            },
            filteredCount: {
              type: Number,
              computed: 'countFiltered(filteredAllocations)'
            },
            dateRangeInBase64: {
              type: String,
              value: () => 'MTQ5MDkzMjgwMHwxNDg4MzQ0NDAw'
            }
          }
        }

        ready() {
          // TODO: Add date range encoding
          this.$.ajax.generateRequest();
        }

        isValidCode(c) {
          return c.node_type == 'InternalCode' || c.node_type == 'Task';
        }

        filterAllocations(filter, allocations) {

          if (!allocations) return [];

          if (!filter || filter === '') {
            return allocations.filter(this.isValidCode);
          }

          filter = filter.toLowerCase();

          let isMatch = (a) => this.isValidCode(a) &&
                               (a.caption.toLowerCase().indexOf(filter) != -1 ||
                                a.breadcrumb.some(b => b.indexOf(filter)));

          return allocations.filter(isMatch);

        }

        countAllocations() {
          return this.allocations.filter(this.isValidCode).length;
        }

        countFiltered(filterAllocations) {
          return filterAllocations.length;
        }

        clearFilter() {
          this.$.filterinput.value = '';
          this.$.filterinput.focus();
        }

      }

      Polymer(AllocationsList);

    })();
  </script>
</dom-module>