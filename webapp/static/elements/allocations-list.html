<dom-module id="allocations-list">
  <template>
    <style include="shared-styles">

      #msg {
        margin-top: 3rem;
      }

      .filterheader {
        background-color: var(--primary-color);
        padding: 1rem;
        height: 6rem;
      }

      .filterheader span { color: #fff; }

      em {
        color: var(--secondary-text-color);
      }

      strong {
        display: block;
      }

      paper-spinner, h2 {
        display: inline-block;
        margin-right: 1rem;
      }

      iron-list,
      .tree-view {
        height: 79vh;
      }

      .tree-view {
        color: var(--primary-text-color);
        padding: 0.5rem;
        overflow: auto;
      }

      paper-input {
        width: calc(100% - 2rem);
        --paper-input-container-input-color: #eee;
        --paper-input-container-focus-color: #444;
        --secondary-text-color: #eee;
        --paper-input-prefix: { color: var(--secondary-text-color, #eee); }
        --paper-input-suffix: { color: var(--secondary-text-color, #eee); }
      }

      paper-toggle-button {
        margin-left: 0.5rem;
        --paper-toggle-button-checked-bar-color: #000;
      }

      paper-item-body {
        --paper-item-body-two-line-min-height: 30px;
      }

      paper-item {
        border-bottom: solid 1px #ddd;
      }

      breadcrumb-display {
        font-size: 12px;
      }

    </style>

    <iron-ajax id="ajax"
      url="/allocations/[[dateRangeInBase64]]"
      method="get"
      handle-as="json"
      loading="{{loading}}"
      on-response="buildTree"
      last-response="{{rawAllocations}}">
    </iron-ajax>

    <div id="msg" hidden="{{!loading}}" class="horizontal layout center center-center">
      <paper-spinner active></paper-spinner>
      <em>Retrieving your allocations...</em>
    </div>

    <div hidden="{{loading}}">

      <paper-material elevation="2" class="filterheader">
        <div class="horizontal layout">
          <span class="flex">
            Showing [[filteredCount]] out of [[allocationCount]] Allocations
          </span>
          <div class="horizontal layout">
            <span>Tree View</span>
            <paper-toggle-button id="viewToggle"
              on-tap="switchView">
            </paper-toggle-button>
          </div>
        </div>
        <paper-input id="filterinput"
          autofocus
          value="{{filter}}"
          label="Filter allocations">
          <div prefix>
            <iron-icon icon="filter-list"></iron-icon>
          </div>
          <div suffix>
            <paper-icon-button icon="clear" on-tap="clearFilter">
            </paper-icon-button>
          </div>
        </paper-input>
      </paper-material>

      <iron-pages selected="{{selectedView}}">

        <iron-list id="codelist"
          items="[[filteredAllocations]]"
          selection-enabled
          selected-item="{{selectedCode}}">
          <template>
            <paper-item>
              <paper-item-body two-line>
                <strong>[[item.caption]]</strong>
                <breadcrumb-display item="[[item]]" secondary></breadcrumb-display>
              </paper-item-body>
            </paper-item>
          </template>
        </iron-list>

        <div class="tree-view">
          <paper-tree id="treeView"
            on-select="selectCode">
          </paper-tree>
        </div>

      </iron-pages>

    </div>

    <breadcrumb-display id="breadcrumbDisplay"></breadcrumb-display>

  </template>
  <script>
    (() => {
      'use strict';

      function arraysEqual(a, b) {
        if (a === b) return true;
        if (a == null || b == null || a.length != b.length) return false;
        for (var i=0; i < a.length; ++i) {
          if (a[i] !== b[i]) return false;
        }
        return true;
      }

      class Tree {

        constructor(data) {
          this.data = data || null;
          this.open = false;
          this.children = [];
        }

        add(data) {
          this.children.push(new Tree(data));
        }

        get(index) {
          this.children.length > 0 ? this.children[index] : null;
        }

        traverse(node, action, level) {
          if (!level) level = 0;
          action(node, level);
          node.children.forEach(n => this.traverse(n, action, level + 1));
        }

        get name() {
          return this.data.caption;
        }

        get icon() {
          return this.children.length === 0 ? 'assignment' : 'folder-open';
        }

      }

      class AllocationsList {

        get is() { return 'allocations-list' }

        get properties() {
          return {
            selectedCode: {
              type: Object,
              notify: true
            },
            allocations: {
              type: Array,
              notify: true
            },
            treeAllocations: {
              type: Object,
              notify: true
            },
            filteredAllocations: {
              type: Array,
              notify: true,
              computed: 'filterAllocations(filter, allocations)'
            },
            allocationCount: {
              type: Number,
              computed: 'countAllocations(allocations)'
            },
            filteredCount: {
              type: Number,
              computed: 'countFiltered(filteredAllocations)'
            },
            dateRangeInBase64: {
              type: String,
              value: () => 'MTQ5MDkzMjgwMHwxNDg4MzQ0NDAw'
            },
            selectedView: {
              type: Number,
              value: () => 0
            }
          }
        }

        ready() {
          // TODO: Add date range encoding
          this.$.ajax.generateRequest();
        }

        switchView() {
          this.selectedView = this.$.viewToggle.active ? 1 : 0;
          this.$.filterinput.disabled = this.$.viewToggle.active;
        }

        isValidCode(c) {
          return c.node_type == 'InternalCode' || c.node_type == 'Task';
        }

        filterAllocations(filter, allocations) {

          if (!allocations) return [];

          if (!filter || filter === '') {
            return allocations.filter(this.isValidCode);
          }

          filter = filter.toLowerCase();

          let isMatch = (a) => this.isValidCode(a) &&
                               (a.caption.toLowerCase().indexOf(filter) != -1 ||
                                this.$.breadcrumbDisplay.getBreadcrumb(a)
                                  .join('').indexOf(filter) != -1);

          return allocations.filter(isMatch);

        }

        countAllocations() {
          return this.allocations.filter(this.isValidCode).length;
        }

        countFiltered(filterAllocations) {
          return filterAllocations.length;
        }

        clearFilter() {
          this.$.filterinput.value = '';
          this.$.filterinput.focus();
        }

        selectCode(event, node) {
          this.selectedCode = node.data.data;
        }

        buildTree() {

          function getParent(node, root) {
            let deepest = root,
                oparts = node.outline.split('.');

            root.traverse(root, (ppn, level) => {
              let parts = ppn.data.outline.split('.');
              if (parts.length != oparts.length - 1) return;
              if (arraysEqual(parts, oparts.slice(0, oparts.length - 1))) {
                deepest = ppn;
              }
            });

            return deepest;
          }

          let treeAllocations = new Tree({
            node_type: 'root',
            caption: 'Root',
            outline: '0'
          });

          this.async(function() {

            let allocations = [];

            this.rawAllocations.forEach((alloc, idx) => {
              let parent = getParent(alloc, treeAllocations);
              alloc['parent'] = parent;
              parent.add(alloc);
              allocations.push(alloc);
            });

            this.treeAllocations = treeAllocations;
            this.treeAllocations.open = true;

            this.allocations = allocations;
            this.$.treeView.data = treeAllocations;

          });
        }

      }

      Polymer(AllocationsList);

    })();
  </script>
</dom-module>