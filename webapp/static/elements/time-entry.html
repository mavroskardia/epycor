<script src="../bower_components/moment/min/moment.min.js"></script>

<dom-module id="time-entry">
  <template>

    <style include="shared-styles">

      paper-card, current-charges {
        margin: 1rem;
        display: block;
      }

      charge-autocomplete, week-entry, current-charges {
        display: block;
      }

      charge-autocomplete {
        margin-bottom: 2rem;
      }

      week-entry {
        width: 100%;
      }

      paper-dialog h2 {
        padding: 1rem;
      }

    </style>

    <iron-ajax id="timeSubmitAjax"
      url="/entertime"
      method="post"
      handle-as="json"
      content-type="application/json"
      on-response="respond"
      on-error="respondToError">
    </iron-ajax>

    <iron-ajax id="markForApprovalAjax"
      url="/markforapproval"
      method="post"
      handle-as="json"
      content-type="application/json"
      on-response="respond"
      on-error="respondToError">
    </iron-ajax>

    <iron-ajax id="timeDeleteAjax"
      url="/deletetime"
      method="post"
      handle-as="json"
      content-type="application/json"
      on-response="respond">
    </iron-ajax>

    <paper-toast id="toast"></paper-toast>

    <paper-card heading="Add Charges">

      <div class="card-content">

        <charge-autocomplete
          selected-code="{{selectedCode}}"
          filtered-allocations="[[filteredAllocations]]">
        </charge-autocomplete>

        <div class="horizontal layout center center-center">
          <paper-icon-button icon="chevron-left" on-tap="prevWeek"></paper-icon-button>
          <week-entry current-date="{{currentDate}}" charges="{{charges}}"></week-entry>
          <paper-icon-button icon="chevron-right" on-tap="nextWeek"></paper-icon-button>
        </div>

        <paper-textarea id="comments"
          label="Comments"
          max-rows="3"
          char-counter="true"
          maxlength="255">
        </paper-textarea>

      </div>

      <div class="card-actions">
        <paper-button on-tap="save">Save</paper-button>
      </div>

    </paper-card>

    <paper-card heading="Charges for Week [[weekRange(currentDate)]]">

      <div class="card-content">
        <current-charges
          id="currentCharges"
          selected-charges="{{selectedCharges}}"
          current-date="[[currentDate]]">
        </current-charges>
      </div>

      <div class="card-actions">
        <paper-button on-tap="markForApproval">Submit for Approval</paper-button>
        <paper-button on-tap="delete">Delete</paper-button>
      </div>

    </paper-card>

    <paper-dialog id="deleteConfirmDialog"
      entry-animation="scale-up-animation"
      exit-animation="fade-out-animation">
      <h2>Delete [[selectedCharges.length]] Entries?</h2>
      <div class="buttons">
        <paper-button dialog-dismiss>Cancel</paper-button>
        <paper-button dialog-confirm autofocus on-tap="performDelete">Delete</paper-button>
      </div>
    </paper-dialog>

  </template>

  <script>
    (() => {
      'use strict';

      class TimeEntry {

        get is() { return 'time-entry' }

        get properties() {
          return {
            currentDate: {
              type: Object,
              value: () => moment().day(0)
            },
            selectedCode: {
              type: Object,
              notify: true
            }
          }
        }

        prevWeek() {
          this.currentDate = moment(this.currentDate.subtract(1, 'week'));
        }

        nextWeek() {
          this.currentDate = moment(this.currentDate.add(1, 'week'));
        }

        weekRange(date) {
          let start = moment(date).day(0).format('MM/DD'),
              end = moment(date).day(6).format('MM/DD');

          return `${start} to ${end}`;
        }

        save() {

          this.$.timeSubmitAjax.body = {
            task: this.selectedCode,
            charges: this.charges,
            date: this.currentDate,
            comments: this.$.comments.value
          };

          this.$.timeSubmitAjax.generateRequest();

        }

        delete() {
          this.$.deleteConfirmDialog.open();
        }

        performDelete() {

          this.$.timeDeleteAjax.body = {
            tasks: this.selectedCharges
          };

          this.$.timeDeleteAjax.generateRequest();

        }

        markForApproval() {

          this.$.markForApprovalAjax.body = {
            tasks: this.selectedCharges
          };

          this.$.markForApprovalAjax.generateRequest();

        }

        respond() {
          this.$.currentCharges.regenerate();
        }

        respondToError(event, detail) {
          this.$.toast.show({
            text: event.detail.request.xhr.response.message
          });
        }

      }

      Polymer(TimeEntry);

    })();
  </script>
</dom-module>