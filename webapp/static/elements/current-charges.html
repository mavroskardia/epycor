<dom-module id="current-charges">
  <template>
    <style include="shared-styles">

      iron-list {
        height: 34vh;
      }

      .selected { font-weight: bold; }

    </style>

    <iron-ajax
      id="ajax"
      auto
      url="/charges/[[asBase64(currentDate)]]"
      handle-as="json"
      on-response="animate"
      last-response="{{charges}}">
    </iron-ajax>

    <iron-list
      id="chargesList"
      items="[[charges]]"
      selected-items="{{selectedCharges}}"
      selection-enabled
      multi-selection>
      <template>
        <paper-icon-item class$="[[_computeSelected(selected)]]">
          <charge-item-display charge="[[item]]" item-icon>
          </charge-item-display>
          <paper-item-body two-line>
            <div class="horizontal layout">
              <span class="flex">[[getItemTitle(item)]]</span>
              <span>[[item.Hours]]</span>
            </div>
            <div secondary>
              <small>[[item.WorkComment]]</small>
            </div>
          </paper-item-body>
        </paper-icon-item>
      </template>
    </iron-list>

  </template>
  <script>
    (() => {
      'use strict';

      class CurrentCharges {
        get is() { return 'current-charges' }

        get behaviors() {
          return [
            Polymer.NeonAnimationRunnerBehavior
          ];
        }

        get properties() {
          return {
            selectedCharges: {
              type: Array,
              notify: true
            },
            animationConfig: {
              value: function () {
                return {
                  'cool': [{
                    name: 'cascaded-animation',
                    animation: 'fade-in-animation'
                  }]
                };
              }
            }

          };
        }

        animate() {
          this.async(() => {
            let items = Polymer.dom(this.root).querySelectorAll('paper-icon-item');
            this.animationConfig['cool'][0].nodes = items;
            this.playAnimation('cool');
          });
        }

        regenerate() {
          let date = this.asBase64(this.currentDate);
          this.$.ajax.url = `/charges/${date}`;
          this.$.ajax.generateRequest();
        }

        getItemTitle(item) {
          return item.ActivityCode ? item.ActivityCode : item.TaskName;
        }

        asBase64(date) {
          let start = moment(date).day(0).hour(0).minute(0).unix();
          let end = moment(date).day(6).hour(23).minute(59).unix();
          return btoa(start + '|' + end);
        }

        _computeSelected(selected) {
          return selected ? 'selected' : '';
        }
      }

      Polymer(CurrentCharges);

    })();
  </script>
</dom-module>