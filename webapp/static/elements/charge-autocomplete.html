<dom-module id="charge-autocomplete">
  <template>
    <style include="shared-styles">

      iron-icon, paper-icon-button {
        color: #888;
        margin-top: 1rem;
      }

      breadcrumb-display:not(.breadcrumb) {
        display: block;
        margin: 0 auto;
        width: calc(100% - 2rem);
        font-size: 70%;
        overflow: hidden;
        min-height: 30px;
        line-height: 0.5rem;
        color: #888;
      }

      paper-autocomplete {
        display: block;
        width: 100%;
      }

      .breadcrumb {
        font-size: 70%;
      }

    </style>

    <div class="horizontal layout center center-center">

      <iron-icon prefix icon="search"></iron-icon>

      <paper-autocomplete
        id="autocomplete"
        label="Search for a charge code"
        source="[[eligibleAllocations(allocations)]]"
        on-autocomplete-selected="selectCode">

        <template autocomplete-custom-template>
          <paper-item
            id$="[[_getSuggestionId(index)]]"
            on-tap="_onSelect"
            role="option"
            aria-selected="false">
            <paper-item-body two-line>
              <div>[[item.text]]</div>
              <breadcrumb-display
                item="[[item.value]]"
                class="breadcrumb"
                secondary>
              </breadcrumb-display>
            </paper-item-body>
          </paper-item>
        </template>

      </paper-autocomplete>

    </div>

    <breadcrumb-display
      id="breadcrumbDisplay"
      item="[[selectedCode]]">
    </breadcrumb-display>

  </template>
  <script>
    (() => {
      'use strict';

      class ChargeAutocomplete {
        get is() { return 'charge-autocomplete' }

        get properties() {
          return {
            selectedCode: {
              type: Object,
              notify: true,
              observer: 'selectedCodeChanged'
            }
          };
        }

        selectedCodeChanged(newsc, oldsc) {
          if (!newsc) return;
          this.$.autocomplete.text = newsc.caption;
          this.$.autocomplete.value = newsc;

        }

        selectCode(e, detail) {
          this.selectedCode = detail.value;
          this.fire('code-selected');
        }

        clear(skipFocus) {
          this.$.autocomplete._clear();
          this.selectedCode = undefined;
        }

        eligibleAllocations(allocations) {
          return allocations
            .filter(a => a.node_type === 'InternalCode' ||
                         a.node_type === 'Task')
            .map(a => ({ text: a.caption, value: a }));
        }
      }

      Polymer(ChargeAutocomplete);

    })();
  </script>
</dom-module>