<dom-module id="current-charges">
  <template>
    <style include="shared-styles">

      paper-card {
        width: 100%;
      }

      paper-icon-item {
        min-height: 0;
      }

      paper-dialog h2 {
        padding: 1rem;
      }

      paper-tabs {
        --paper-tabs-selection-bar-color: var(--primary-color);
      }

      #toggleView {
        position: absolute;
        top: -2.5rem;
        right: 1rem;
      }

    </style>

    <iron-ajax id="markForApprovalAjax"
      url="/markforapproval"
      method="post"
      handle-as="json"
      content-type="application/json"
      on-response="respond"
      on-error="respondToError">
    </iron-ajax>

    <iron-ajax id="timeDeleteAjax"
      url="/deletetime"
      method="post"
      handle-as="json"
      content-type="application/json"
      on-response="respond">
    </iron-ajax>

    <iron-ajax
      id="ajax"
      auto
      url="/charges/[[asBase64(currentDate)]]"
      handle-as="json"
      on-response="animate"
      last-response="{{charges}}">
    </iron-ajax>

    <paper-card class="flex" heading="Charges for Week [[weekRange(currentDate)]]">

      <div class="card-content">

        <paper-toggle-button id="toggleView"
          on-tap="switchView">
          Group by Task
        </paper-toggle-button>

        <week-totals
          charges="[[charges]]"
          current-date="[[currentDate]]"
          class="flex">
        </week-totals>

        <empty-set-message hidden="[[charges.length]]"></empty-set-message>

        <iron-pages selected="{{selectedGrouping}}">

          <charge-list-by-task id="chargeListByDate" charges="[[charges]]">
          </charge-list-by-task>

          <charge-list id="chargeListByTask" charges="[[charges]]">
          </charge-list>

        </iron-pages>

      </div>

      <div class="card-actions list-actions">
        <div class="horizontal layout">
          <paper-icon-button
            icon="content-copy"
            on-tap="copySelected"
            disabled="[[!selectedCharges.length]]">
          </paper-icon-button>
          <paper-icon-button
            id="pasteButton"
            icon="content-paste"
            on-tap="pasteSelected"
            disabled="[[!copiedCharges.length]]">
          </paper-icon-button>
          <paper-badge hidden$="[[!copiedCharges.length]]" for="pasteButton" label="[[copiedCharges.length]]">
          </paper-badge>
          <paper-icon-button
            icon="select-all"
            on-tap="selectAll">
          </paper-icon-button>
          <div class="flex"></div>
          <paper-button on-tap="markForApproval" disabled="[[!selectedCharges.length]]">
            Submit for Approval
          </paper-button>
          <paper-button on-tap="delete" disabled="[[!selectedCharges.length]]">
            Delete
          </paper-button>
        </div>
      </div>

    </paper-card>

    <paper-dialog id="deleteConfirmDialog"
      entry-animation="scale-up-animation"
      exit-animation="fade-out-animation">
      <h2>Delete [[selectedCharges.length]] Entries?</h2>
      <div class="buttons">
        <paper-button dialog-dismiss>Cancel</paper-button>
        <paper-button dialog-confirm autofocus on-tap="performDelete">Delete</paper-button>
      </div>
    </paper-dialog>

    <paper-toast id="toast"></paper-toast>

  </template>
  <script>
    (() => {
      'use strict';

      class CurrentCharges {

        static get is() { return 'current-charges' }

        get properties() {
          return {
            selectedCharges: {
              type: Array,
              notify: true
            },
            selectedGrouping: {
              type: Number,
              value: () => 0
            },
            copiedCharges: {
              type: Array,
              value: () => []
            }
          };
        }

        get behaviors() {
          return [ Epycor.UtilityBehaviors ];
        }

        animate() {
          this.async(() => {
            this.$.chargeListByTask.animate();
            this.$.chargeListByDate.animate();
          });
        }

        regenerate() {
          let date = this.asBase64(this.currentDate);
          this.$.ajax.url = `/charges/${date}`;
          this.$.ajax.generateRequest();
        }

        switchView() {
          this.selectedGrouping = this.$.toggleView.active ? 1 : 0;
        }

        weekRange(date) {
          let start = moment(date).day(0).format('MM/DD'),
              end = moment(date).day(6).format('MM/DD');

          return `${start} to ${end}`;
        }

        asBase64(date) {
          let start = moment(date).day(0).hour(0).minute(0).unix();
          let end = moment(date).day(6).hour(23).minute(59).unix();
          return btoa(start + '|' + end);
        }

        delete() {
          this.$.deleteConfirmDialog.open();
        }

        performDelete() {

          this.$.timeDeleteAjax.body = {
            tasks: this.selectedCharges
          };

          this.$.timeDeleteAjax.generateRequest();

        }

        markForApproval() {

          this.$.markForApprovalAjax.body = {
            tasks: this.selectedCharges
          };

          this.$.markForApprovalAjax.generateRequest();

        }

        respond() {
          this.regenerate();
          this.fire('response');
        }

        respondToError(event, detail) {
          this.$.toast.show({
            text: event.detail.request.xhr.response.message
          });
        }

        copySelected() {
          this.copiedCharges = this.$.chargesList.selectedItems.slice();
        }

        pasteSelected() {
          this.fire('paste', this.copiedCharges);
        }

        selectAll() {
          if (this.selectedGrouping == 0) {
            this.$.chargeListByDate.selectAll();
          } else if (this.selectedGrouping == 1) {
            this.$.chargeListByTask.selectAll();
          } else {
            console.warn(`selected grouping in invalid state: ${this.selectedGrouping}`);
          }
        }

      }

      Polymer(CurrentCharges);

    })();
  </script>
</dom-module>