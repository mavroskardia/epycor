<dom-module id="current-charges">
  <template>
    <style include="shared-styles">

      .selected {
        background-color: var(--primary-color);
        --paper-item-icon: {
          color: #fff;
        };
      }

      .selected strong,
      .selected span,
      .selected charge-item-display {
        color: #fff;
      }

      .selected small { color: #ddd; }

      iron-list {
        height: 29vh;
      }

      paper-card {
        width: 100%;
      }

      paper-icon-item {
        min-height: 0;
      }

      paper-dialog h2 {
        padding: 1rem;
      }

    </style>

    <iron-ajax id="markForApprovalAjax"
      url="/markforapproval"
      method="post"
      handle-as="json"
      content-type="application/json"
      on-response="respond"
      on-error="respondToError">
    </iron-ajax>

    <iron-ajax id="timeDeleteAjax"
      url="/deletetime"
      method="post"
      handle-as="json"
      content-type="application/json"
      on-response="respond">
    </iron-ajax>

    <iron-ajax
      id="ajax"
      auto
      url="/charges/[[asBase64(currentDate)]]"
      handle-as="json"
      on-response="animate"
      last-response="{{charges}}">
    </iron-ajax>

    <paper-card class="flex" heading="Charges for Week [[weekRange(currentDate)]]">

      <div class="card-content">

        <week-totals charges="[[charges]]" current-date="[[currentDate]]">
        </week-totals>

        <iron-list
          id="chargesList"
          items="[[sortedCharges(charges.*)]]"
          selected-items="{{selectedCharges}}"
          selection-enabled
          multi-selection>
          <template>
            <paper-icon-item class$="[[_computeSelected(selected)]]">
              <charge-item-display charge="[[item]]" item-icon>
              </charge-item-display>
              <paper-item-body two-line>
                <div class="horizontal layout">
                  <span class="flex">[[getItemTitle(item)]]</span>
                  <strong>[[item.Hours]]</strong>
                </div>
                <div secondary>
                  <small>[[item.WorkComment]]</small>
                </div>
              </paper-item-body>
            </paper-icon-item>
          </template>
        </iron-list>

      </div>

      <div class="card-actions list-actions">
        <div class="horizontal layout">
          <paper-icon-button
            icon="content-copy"
            on-tap="copySelected"
            disabled="[[!selectedCharges.length]]">
          </paper-icon-button>
          <paper-icon-button
            id="pasteButton"
            icon="content-paste"
            on-tap="pasteSelected"
            disabled="[[!copiedCharges.length]]">
          </paper-icon-button>
          <paper-badge hidden$="[[!copiedCharges.length]]" for="pasteButton" label="[[copiedCharges.length]]">
          </paper-badge>
          <paper-icon-button
            icon="select-all"
            on-tap="selectAll">
          </paper-icon-button>
          <div class="flex"></div>
          <paper-button on-tap="markForApproval" disabled="[[!selectedCharges.length]]">
            Submit for Approval
          </paper-button>
          <paper-button on-tap="delete" disabled="[[!selectedCharges.length]]">
            Delete
          </paper-button>
        </div>
      </div>

    </paper-card>

    <paper-dialog id="deleteConfirmDialog"
      entry-animation="scale-up-animation"
      exit-animation="fade-out-animation">
      <h2>Delete [[selectedCharges.length]] Entries?</h2>
      <div class="buttons">
        <paper-button dialog-dismiss>Cancel</paper-button>
        <paper-button dialog-confirm autofocus on-tap="performDelete">Delete</paper-button>
      </div>
    </paper-dialog>

    <paper-toast id="toast"></paper-toast>

  </template>
  <script>
    (() => {
      'use strict';

      class CurrentCharges {
        get is() { return 'current-charges' }

        get behaviors() {
          return [
            Polymer.NeonAnimationRunnerBehavior
          ];
        }

        get properties() {
          return {
            selectedCharges: {
              type: Array,
              notify: true
            },
            copiedCharges: {
              type: Array,
              value: () => []
            },
            animationConfig: {
              value: function () {
                return {
                  'cool': [{
                    name: 'cascaded-animation',
                    animation: 'fade-in-animation'
                  }]
                };
              }
            }

          };
        }

        animate() {
          this.async(() => {
            let items = Polymer.dom(this.root).querySelectorAll('paper-icon-item');
            this.animationConfig['cool'][0].nodes = items;
            this.playAnimation('cool');
          });
        }

        regenerate() {
          let date = this.asBase64(this.currentDate);
          this.$.ajax.url = `/charges/${date}`;
          this.$.ajax.generateRequest();
        }

        getItemTitle(item) {
          return item.ActivityCode ? item.ActivityCode : item.TaskName;
        }

        weekRange(date) {
          let start = moment(date).day(0).format('MM/DD'),
              end = moment(date).day(6).format('MM/DD');

          return `${start} to ${end}`;
        }

        asBase64(date) {
          let start = moment(date).day(0).hour(0).minute(0).unix();
          let end = moment(date).day(6).hour(23).minute(59).unix();
          return btoa(start + '|' + end);
        }

        sortedCharges(chargesPath) {
          return chargesPath.base
            .sort((a, b) => moment(a.TimeEntryDate) - moment(b.TimeEntryDate));
        }

        _computeSelected(selected) {
          return selected ? 'selected' : '';
        }

        delete() {
          this.$.deleteConfirmDialog.open();
        }

        performDelete() {

          this.$.timeDeleteAjax.body = {
            tasks: this.selectedCharges
          };

          this.$.timeDeleteAjax.generateRequest();

        }

        markForApproval() {

          this.$.markForApprovalAjax.body = {
            tasks: this.selectedCharges
          };

          this.$.markForApprovalAjax.generateRequest();

        }

        respond() {
          this.regenerate();
          this.fire('response');
        }

        respondToError(event, detail) {
          this.$.toast.show({
            text: event.detail.request.xhr.response.message
          });
        }

        copySelected() {
          this.copiedCharges = this.$.chargesList.selectedItems.slice();
        }

        pasteSelected() {
          this.fire('paste', this.copiedCharges);
        }

        selectAll() {
          let list = this.$.chargesList;
          if (list.selectedItems.length === list.items.length) {
            this.$.chargesList.items.forEach(i => this.$.chargesList.deselectItem(i));
          } else {
            this.$.chargesList.items.forEach(i => this.$.chargesList.selectItem(i));
          }
        }

      }

      Polymer(CurrentCharges);

    })();
  </script>
</dom-module>