<script src="../bower_components/moment/min/moment.min.js"></script>

<dom-module id="time-entry">
  <template>

    <style include="shared-styles">

      paper-card, current-charges {
        margin: 1rem 1rem 0rem 1rem;
        display: block;
        width: calc(100% - 2rem);
      }

      charge-autocomplete {
        margin-bottom: 1rem;
        display: block;
      }

      week-entry {
        width: 100%;
      }

      .list-actions {
        text-align: left;
      }

      paper-icon-button {
        color: #444;
      }

      paper-dialog h2 { padding: 1rem; }

    </style>

    <iron-ajax id="timeSubmitAjax"
      url="/entertime"
      method="post"
      handle-as="json"
      content-type="application/json"
      on-response="respond"
      on-error="respondToError">
    </iron-ajax>

    <paper-toast id="toast"></paper-toast>

    <div class="vertical layout center">

      <paper-card heading="Add Charges">

        <div class="card-content">

          <charge-autocomplete id="chargeAutocomplete"
            selected-code="{{selectedCode}}"
            on-code-selected="focusOnMonday"
            allocations="[[allocations]]"
            tree-allocations="[[treeAllocations]]">
          </charge-autocomplete>

          <div class="horizontal layout center center-center">
            <paper-icon-button icon="arrow-back" on-tap="prevWeek"></paper-icon-button>
            <week-entry id="weekEntry"
              current-date="{{currentDate}}"
              charges="{{charges}}">
            </week-entry>
            <paper-icon-button icon="arrow-forward" on-tap="nextWeek"></paper-icon-button>
          </div>

          <paper-textarea id="comments"
            label="Comments"
            max-rows="3"
            char-counter="true"
            maxlength="255">
          </paper-textarea>

        </div>

        <div class="card-actions">
          <paper-button on-tap="save" disabled="[[!readyForSave]]">
            Save
          </paper-button>
        </div>

      </paper-card>

      <current-charges id="currentCharges"
        class="flex"
        selected-charges="{{selectedCharges}}"
        current-date="[[currentDate]]"
        on-response="respond"
        on-paste="showPasteDialog">
      </current-charges>

    </div>

    <paper-dialog id="pasteDialog"
      entry-animation="scale-up-animation"
      exit-animation="fade-out-animation">
      <h2>Paste [[clipboardItems.length]] Charges to Which Date?</h2>
      <paper-dialog-scrollable>
        <paper-date-picker id="datePicker"
          date="{{pasteDate}}"
          force-narrow>
        </paper-date-picker>
      </paper-dialog-scrollable>
      <div class="buttons">
        <paper-button on-tap="saveClipboard" dialog-confirm>Paste</paper-button>
        <paper-button dialog-dismiss>Cancel</paper-button>
      </div>
    </paper-dialog>

  </template>

  <script>
    (() => {
      'use strict';

      class TimeEntry {

        get is() { return 'time-entry' }

        get properties() {
          return {
            currentDate: {
              type: Object,
              value: () => moment().day(0)
            },
            selectedCode: {
              type: Object,
              notify: true
            }
          }
        }

        get observers() {
          return [
            'chargesOrCodeChanged(charges.*, selectedCode)'
          ]
        }

        prevWeek() {
          this.currentDate = moment(this.currentDate.subtract(1, 'week'));
        }

        nextWeek() {
          this.currentDate = moment(this.currentDate.add(1, 'week'));
        }

        chargesOrCodeChanged(charges, selectedCode) {
          this.readyForSave = !!selectedCode &&
                              charges.base.some(c => c.hours > 0);
        }

        focusOnMonday() {
          this.$.weekEntry.focusOnMonday();
        }

        saveClipboard() {
          this.$.toast.show({
            text: 'Coming soon!'
          });

          this.clipboardItems.forEach(ci => {
            let oldDate = moment(ci.TimeEntryDate),
                newDate = moment(this.pasteDate),
                hours = [{hours:0}, {hours:0}, {hours:0}, {hours:0}, {hours:0}, {hours:0}, {hours:0}];

            hours[newDate.day()] = {hours:ci.Hours};

            this.saveTask({data:ci}, newDate.day(0).toISOString(), hours, ci.WorkComment);
          });
        }

        showPasteDialog(event, charges) {
          this.clipboardItems = charges;
          this.$.pasteDialog.open();
        }

        saveTask(task, date, hours, comments) {

          function removeParents(c) {
            let ret = {};

            for (var p in c) {
              if (c.hasOwnProperty(p) && p != 'parent') {
                ret[p] = c[p];
              }
            }

            return ret;
          }

          this.$.timeSubmitAjax.body = {
            task: removeParents(task),
            charges: hours,
            date: date,
            comments: comments
          };

          this.$.timeSubmitAjax.generateRequest();

        }

        save() {
          this.saveTask(this.selectedCode, this.currentDate, this.charges,
                        this.$.comments.value);
        }

        respond() {
          this.$.weekEntry.clear();
          this.$.chargeAutocomplete.clear(true);
          this.$.comments.value = '';
          this.$.currentCharges.regenerate();
          this.$.chargeAutocomplete.focus();
        }

        respondToError(event, detail) {
          this.$.toast.show({
            text: event.detail.request.xhr.response.message
          });
        }

      }

      Polymer(TimeEntry);

    })();
  </script>
</dom-module>